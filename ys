[1mdiff --git a/app.py b/app.py[m
[1mindex 3027282..36389c3 100644[m
[1m--- a/app.py[m
[1m+++ b/app.py[m
[36m@@ -1518,9 +1518,23 @@[m [mdef get_scheduled_tasks():[m
         for task in tasks:[m
             slots = [][m
             executing_slot_index = None[m
[32m+[m[32m            last_completed_slot_index = None[m
[32m+[m[32m            executing_slot_id = None[m
[32m+[m[32m            current_slot_db_id = None[m
[32m+[m[41m            [m
[32m+[m[32m            # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ —Å–ª–æ—Ç–∞–º –∏ –Ω–∞—Ö–æ–¥–∏–º:[m
[32m+[m[32m            # 1. –¢–µ–∫—É—â–∏–π –≤—ã–ø–æ–ª–Ω—è–µ–º—ã–π —Å–ª–æ—Ç (executing)[m
[32m+[m[32m            # 2. –ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π —Å–ª–æ—Ç (completed)[m
             for idx, slot in enumerate(task.time_slots.order_by(ScheduledTimeSlot.scheduled_datetime.asc())):[m
[32m+[m[32m                # –ò—â–µ–º executing —Å–ª–æ—Ç[m
                 if slot.status == 'executing':[m
                     executing_slot_index = idx[m
[32m+[m[32m                    executing_slot_id = slot.id[m
[32m+[m[41m                [m
[32m+[m[32m                # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π[m
[32m+[m[32m                if slot.status == 'completed' or slot.status == 'completed_with_errors':[m
[32m+[m[32m                    last_completed_slot_index = idx[m
[32m+[m[41m                [m
                 slots.append({[m
                     'id': slot.id,[m
                     'datetime': slot.scheduled_datetime.isoformat(),[m
[36m@@ -1531,9 +1545,24 @@[m [mdef get_scheduled_tasks():[m
                     'percentage': round((slot.processed_recipients / slot.total_recipients * 100), 1) if slot.total_recipients > 0 else 100[m
                 })[m
             [m
[31m-            # Get recipients status with slot info[m
[31m-            executing_slot_id = slots[executing_slot_index]['id'] if executing_slot_index is not None else None[m
[31m-            current_slot_index = (executing_slot_index + 1) if executing_slot_index is not None else 1[m
[32m+[m[32m            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å (–ø–ª–∞–≤–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å)[m
[32m+[m[32m            # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:[m
[32m+[m[32m            # 1. –ï—Å–ª–∏ –µ—Å—Ç—å executing —Å–ª–æ—Ç - —ç—Ç–æ —Ç–µ–∫—É—â–∏–π[m
[32m+[m[32m            # 2. –ò–Ω–∞—á–µ - –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π —Å–ª–æ—Ç[m
[32m+[m[32m            # 3. –ò–Ω–∞—á–µ - –∏–Ω–¥–µ–∫—Å 0 (–Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—á–∏–Ω–∞–ª–æ—Å—å)[m
[32m+[m[41m            [m
[32m+[m[32m            if executing_slot_index is not None:[m
[32m+[m[32m                # –ï—Å—Ç—å –≤—ã–ø–æ–ª–Ω—è—é—â–∏–π—Å—è —Å–ª–æ—Ç[m
[32m+[m[32m                current_slot_index = executing_slot_index + 1[m
[32m+[m[32m                current_slot_db_id = executing_slot_id[m
[32m+[m[32m            elif last_completed_slot_index is not None:[m
[32m+[m[32m                # –ù–µ—Ç executing, –Ω–æ –µ—Å—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ[m
[32m+[m[32m                current_slot_index = last_completed_slot_index + 1[m
[32m+[m[32m                current_slot_db_id = slots[last_completed_slot_index]['id'][m
[32m+[m[32m            else:[m
[32m+[m[32m                # –ù–∏—á–µ–≥–æ –µ—â–µ –Ω–µ –Ω–∞—á–∏–Ω–∞–ª–æ—Å—å[m
[32m+[m[32m                current_slot_index = 0[m
[32m+[m[32m                current_slot_db_id = None[m
             [m
             result.append({[m
                 'id': task.id,[m
[36m@@ -1543,10 +1572,14 @@[m [mdef get_scheduled_tasks():[m
                 'has_image': bool(task.image_path),[m
                 'telegram_account': task.telegram_username or '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',[m
                 'slots': slots,[m
[31m-                'recipients_info': get_task_recipients_status(task.id, slot_id=executing_slot_id, current_slot_index=current_slot_index, total_slots=len(slots))[m
[32m+[m[32m                'recipients_info': get_task_recipients_status([m
[32m+[m[32m                    task.id,[m
[32m+[m[32m                    current_slot_db_id=current_slot_db_id,[m
[32m+[m[32m                    current_slot_index=current_slot_index,[m
[32m+[m[32m                    total_slots=len(slots)[m
[32m+[m[32m                )[m
             })[m
         [m
[31m-        # Get refresh interval from config[m
         refresh_interval_ms = config.get('scheduler', {}).get('active_tasks_refresh_interval_ms', 2000)[m
         [m
         return jsonify({'success': True, 'tasks': result, 'refresh_interval_ms': refresh_interval_ms})[m
[36m@@ -1554,14 +1587,17 @@[m [mdef get_scheduled_tasks():[m
         logger.error(f"Error in get_scheduled_tasks: {e}")[m
         return jsonify({'success': False, 'error': str(e)})[m
 [m
[31m-def get_task_recipients_status(task_id, slot_id=None, current_slot_index=None, total_slots=None):[m
[31m-    """–°–æ–±–∏—Ä–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø–æ –∫–∞–∂–¥–æ–º—É –ø–æ–ª—É—á–∞—Ç–µ–ª—é –¥–ª—è –∑–∞–¥–∞—á–∏[m
[32m+[m[32mdef get_task_recipients_status(task_id, current_slot_db_id=None, current_slot_index=None, total_slots=None):[m
[32m+[m[32m    """[m
[32m+[m[32m    –°–æ–±–∏—Ä–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º –¥–ª—è –∑–∞–¥–∞—á–∏.[m
[32m+[m[41m    [m
[32m+[m[32m    –î–ª—è –ê–ö–¢–ò–í–ù–´–• –∑–∞–¥–∞—á (current_slot_db_id != None):[m
[32m+[m[32m        - –ë–µ—Ä–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –≤—Å–µ—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ (–î–û –¢–ï–ö–£–©–ï–ì–û –í–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û)[m
[32m+[m[32m        - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º —Å–ª–æ—Ç–∞–º[m
     [m
[31m-    Args:[m
[31m-        task_id: ID –∑–∞–¥–∞—á–∏[m
[31m-        slot_id: ID –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–ª–æ—Ç–∞ (–¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á - —Ç–µ–∫—É—â–∏–π –≤—ã–ø–æ–ª–Ω—è–µ–º—ã–π —Å–ª–æ—Ç)[m
[31m-        current_slot_index: –ü–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ —Å–ª–æ—Ç–∞ (1-based)[m
[31m-        total_slots: –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ—Ç–æ–≤[m
[32m+[m[32m    –î–ª—è –ó–ê–í–ï–†–®–ï–ù–ù–´–• –∑–∞–¥–∞—á (current_slot_db_id == None):[m
[32m+[m[32m        - –ë–µ—Ä–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –í–°–ï–• —Å–ª–æ—Ç–æ–≤[m
[32m+[m[32m        - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç[m
     """[m
     task = db.session.get(ScheduledTask, task_id)[m
     if not task:[m
[36m@@ -1570,7 +1606,7 @@[m [mdef get_task_recipients_status(task_id, slot_id=None, current_slot_index=None, t[m
     try:[m
         from models import SentMessage, ScheduledTimeSlot[m
         [m
[31m-        # 1. –ü–æ–ª—É—á–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–∏–º–µ–Ω–∞) –∏–∑ recipients_info –∑–∞–¥–∞—á–∏[m
[32m+[m[32m        # 1. –ü–æ–ª—É—á–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π (–∏–º–µ–Ω–∞)[m
         recipients_meta = {}[m
         if task.recipients_info:[m
             try:[m
[36m@@ -1580,26 +1616,30 @@[m [mdef get_task_recipients_status(task_id, slot_id=None, current_slot_index=None, t[m
                         recipients_meta[str(item['id'])] = item.get('name') or item.get('title') or item.get('username')[m
             except:[m
                 pass[m
[31m-[m
[31m-        # 2. –ü–æ–ª—É—á–∞–µ–º –∑–∞–ø–∏—Å–∏ –∏–∑ sent_messages[m
[31m-        if slot_id:[m
[31m-            # –î–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á - —Ç–æ–ª—å–∫–æ –ø–æ —Ç–µ–∫—É—â–µ–º—É —Å–ª–æ—Ç—É[m
[31m-            sent_messages = db.session.query(SentMessage).filter([m
[31m-                SentMessage.slot_id == slot_id[m
[31m-            ).all()[m
[32m+[m[41m        [m
[32m+[m[32m        # 2. –ü—Ä–∞–≤–∏–ª—å–Ω–æ –±–µ—Ä–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è[m
[32m+[m[32m        if current_slot_db_id:[m
[32m+[m[32m            # –ê–ö–¢–ò–í–ù–´–ï –ó–ê–î–ê–ß–ò[m
[32m+[m[32m            # –ë–µ—Ä–µ–º —Ç–µ–∫—É—â–∏–π —Å–ª–æ—Ç –∏–∑ –ë–î[m
[32m+[m[32m            current_slot = db.session.get(ScheduledTimeSlot, current_slot_db_id)[m
[32m+[m[41m            [m
[32m+[m[32m            if current_slot:[m
[32m+[m[32m                # –ë–µ—Ä–µ–º –í–°–ï —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —Å–ª–æ—Ç–æ–≤ –î–û –¢–ï–ö–£–©–ï–ì–û (–ø–æ –≤—Ä–µ–º–µ–Ω–∏)[m
[32m+[m[32m                # –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç–æ–ª—å–∫–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤[m
[32m+[m[32m                sent_messages = db.session.query(SentMessage).join(ScheduledTimeSlot).filter([m
[32m+[m[32m                    ScheduledTimeSlot.task_id == task_id,[m
[32m+[m[32m                    ScheduledTimeSlot.scheduled_datetime <= current_slot.scheduled_datetime[m
[32m+[m[32m                ).all()[m
[32m+[m[32m            else:[m
[32m+[m[32m                sent_messages = [][m
         else:[m
[31m-            # –î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á - –≤—Å–µ —Å–ª–æ—Ç—ã[m
[32m+[m[32m            # –ó–ê–í–ï–†–®–ï–ù–ù–´–ï –ó–ê–î–ê–ß–ò[m
[32m+[m[32m            # –ë–µ—Ä–µ–º –í–°–ï —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –∑–∞–¥–∞—á–µ[m
             sent_messages = db.session.query(SentMessage).join(ScheduledTimeSlot).filter([m
                 ScheduledTimeSlot.task_id == task_id[m
             ).all()[m
         [m
[31m-        # ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ recipient_id[m
[31m-        is_task_cancelled = task.was_cancelled[m
[31m-        [m
[31m-        # 4. –°–æ–±–∏—Ä–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π[m
[31m-        recipients_ids = json.loads(task.recipients)[m
[31m-        [m
[31m-        # ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ recipient_id[m
[32m+[m[32m        # 3. –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ recipient_id (–ø–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–ª—è –ö–ê–ñ–î–û–ì–û –∫–æ–Ω—Ç–∞–∫—Ç–∞)[m
         recipient_stats = {}[m
         for sm in sent_messages:[m
             r_id = str(sm.recipient_id)[m
[36m@@ -1620,10 +1660,13 @@[m [mdef get_task_recipients_status(task_id, slot_id=None, current_slot_index=None, t[m
             elif sm.status == 'cancelled':[m
                 recipient_stats[r_id]['cancelled'] += 1[m
             [m
[31m-            # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–∞—Ç—É—Å –∏ –æ—à–∏–±–∫—É[m
[32m+[m[32m            # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–∞—Ç—É—Å (–¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å–ª–æ—Ç–∞)[m
             recipient_stats[r_id]['last_status'] = sm.status[m
             recipient_stats[r_id]['last_error'] = sm.error_message[m
         [m
[32m+[m[32m        is_task_cancelled = task.was_cancelled[m
[32m+[m[32m        recipients_ids = json.loads(task.recipients)[m
[32m+[m[41m        [m
         result = [][m
         for r in recipients_ids:[m
             if isinstance(r, (str, int)):[m
[36m@@ -1631,7 +1674,7 @@[m [mdef get_task_recipients_status(task_id, slot_id=None, current_slot_index=None, t[m
             else:[m
                 r_id = str(r.get('id'))[m
             [m
[31m-            # ‚úÖ –ö–ê–ñ–î–´–ô –∫–æ–Ω—Ç–∞–∫—Ç –ø–æ–ª—É—á–∞–µ—Ç –°–í–û–Æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É[m
[32m+[m[32m            # –ë–µ—Ä–µ–º –°–í–û–Æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞[m
             stats = recipient_stats.get(r_id, {[m
                 'sent': 0,[m
                 'failed': 0,[m
[36m@@ -1641,27 +1684,26 @@[m [mdef get_task_recipients_status(task_id, slot_id=None, current_slot_index=None, t[m
             })[m
             [m
             if stats['last_status']:[m
[31m-                # –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å –≤ sent_messages –µ—Å—Ç—å - –±–µ—Ä–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç—Ç—É–¥–∞[m
                 r_status = stats['last_status'][m
                 r_error = stats['last_error'][m
[31m-                r_name = recipients_meta.get(r_id) or r_id[m
             else:[m
[31m-                # –ï—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç - —Å—Ç–∞—Ç—É—Å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –æ—Ç–º–µ–Ω—ã –∑–∞–¥–∞—á–∏[m
                 r_status = 'cancelled' if is_task_cancelled else 'pending'[m
                 r_error = None[m
[31m-                r_name = recipients_meta.get(r_id) or r_id[m
[32m+[m[41m            [m
[32m+[m[32m            r_name = recipients_meta.get(r_id) or r_id[m
             [m
             result.append({[m
                 'id': r_id,[m
                 'name': r_name,[m
                 'status': r_status,[m
                 'error': r_error,[m
[31m-                'sent_count': stats['sent'],              # ‚úÖ –°–í–û–Ø —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–∞![m
[31m-                'error_count': stats['failed'],           # ‚úÖ –°–í–û–Ø —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–∞![m
[31m-                'cancelled_count': stats['cancelled'],    # ‚úÖ –°–í–û–Ø —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–∞![m
[32m+[m[32m                'sent_count': stats['sent'],[m
[32m+[m[32m                'error_count': stats['failed'],[m
[32m+[m[32m                'cancelled_count': stats['cancelled'],[m
                 'current_slot_index': current_slot_index,[m
                 'total_slots': total_slots[m
             })[m
[32m+[m[41m        [m
         return result[m
     except Exception as e:[m
         logger.error(f"Error gathering recipients status for task {task_id}: {e}")[m
[36m@@ -1792,7 +1834,7 @@[m [mdef get_completed_tasks():[m
                 'total_slots': total_slots,[m
                 'has_image': bool(task.image_path),[m
                 'is_scheduled': True, # –≠—Ç–æ –∑–∞–¥–∞—á–∏ –∏–∑ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞[m
[31m-                'recipients_info': get_task_recipients_status(task.id, slot_id=None, current_slot_index=total_slots, total_slots=total_slots),[m
[32m+[m[32m                'recipients_info': get_task_recipients_status(task.id, current_slot_db_id=None, current_slot_index=total_slots, total_slots=total_slots),[m
                 'time_slots': [{[m
                     'id': s.id,[m
                     'datetime': s.scheduled_datetime.isoformat(),[m
